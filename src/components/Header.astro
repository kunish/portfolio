---
import LanguageSwitcher from './LanguageSwitcher.astro';
import { getLangFromUrl, useTranslations, useTranslatedPath } from '../i18n/utils';

const lang = getLangFromUrl(Astro.url);
const t = useTranslations(lang);
const translatePath = useTranslatedPath(lang);

const pathname = new URL(Astro.request.url).pathname;

const navItems = [
  { label: t('nav.home'), href: translatePath('/') },
  { label: t('nav.blog'), href: translatePath('/blog') },
  { label: t('nav.about'), href: translatePath('/about') },
];
---

<header id="site-header" class="fixed top-0 left-0 right-0 z-50 bg-cream/90 backdrop-blur-sm transition-all duration-300">
  <nav class="container-swiss">
    <div id="header-inner" class="flex items-center justify-between h-20 transition-all duration-300">
      <a href={translatePath('/')} class="flex items-center gap-3 text-text-primary hover:text-text-primary group">
        <span class="font-display text-xl tracking-tight transition-colors group-hover:text-accent">{t('site.title')}</span>
      </a>

      <div class="hidden md:flex items-center gap-8">
        <ul class="flex items-center gap-8">
          {navItems.map((item) => (
            <li>
              <a
                href={item.href}
                class:list={[
                  'nav-link',
                  { 'active': pathname === item.href || (item.href !== '/' && item.href !== '/en' && pathname.startsWith(item.href)) }
                ]}
              >
                {item.label}
              </a>
            </li>
          ))}
        </ul>
        <div class="border-l border-text-primary/15 pl-6 h-5 flex items-center">
          <LanguageSwitcher />
        </div>
      </div>

      <button
        id="mobile-menu-btn"
        class="md:hidden p-2 text-text-primary hover:text-accent transition-colors relative w-10 h-10 flex items-center justify-center"
        aria-label="Toggle menu"
        aria-expanded="false"
      >
        <span class="hamburger-icon">
          <span class="hamburger-line hamburger-line-1"></span>
          <span class="hamburger-line hamburger-line-2"></span>
          <span class="hamburger-line hamburger-line-3"></span>
        </span>
      </button>
    </div>
  </nav>

  <div id="mobile-menu" class="mobile-menu-closed md:hidden bg-cream border-t border-text-primary/8 overflow-hidden">
    <ul class="container-swiss py-8 space-y-2">
      {navItems.map((item, index) => (
        <li class="mobile-menu-item" style={`--delay: ${index * 0.05}s`}>
          <a
            href={item.href}
            class:list={[
              'nav-link block py-3 text-lg',
              { 'active': pathname === item.href || (item.href !== '/' && item.href !== '/en' && pathname.startsWith(item.href)) }
            ]}
          >
            {item.label}
          </a>
        </li>
      ))}
      <li class="pt-6 border-t border-text-primary/8 mobile-menu-item" style="--delay: 0.15s">
        <LanguageSwitcher />
      </li>
    </ul>
  </div>
</header>

<style>
  .hamburger-icon {
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    width: 24px;
    height: 24px;
    position: relative;
  }

  .hamburger-line {
    display: block;
    width: 20px;
    height: 2px;
    background: currentColor;
    position: absolute;
    transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1), opacity 0.2s ease;
  }

  .hamburger-line-1 {
    transform: translateY(-6px);
  }

  .hamburger-line-2 {
    transform: translateY(0);
  }

  .hamburger-line-3 {
    transform: translateY(6px);
  }

  .menu-open .hamburger-line-1 {
    transform: translateY(0) rotate(45deg);
  }

  .menu-open .hamburger-line-2 {
    opacity: 0;
  }

  .menu-open .hamburger-line-3 {
    transform: translateY(0) rotate(-45deg);
  }

  .mobile-menu-closed {
    max-height: 0;
    opacity: 0;
    transition: max-height 0.4s cubic-bezier(0.16, 1, 0.3, 1), opacity 0.3s ease;
  }

  .mobile-menu-open {
    max-height: 400px;
    opacity: 1;
  }

  .mobile-menu-item {
    opacity: 0;
    transform: translateY(8px);
    transition: opacity 0.3s ease, transform 0.3s cubic-bezier(0.16, 1, 0.3, 1);
    transition-delay: var(--delay, 0s);
  }

  .mobile-menu-open .mobile-menu-item {
    opacity: 1;
    transform: translateY(0);
  }

  .header-scrolled {
    background: rgba(247, 244, 239, 0.98) !important;
    backdrop-filter: blur(12px) !important;
    box-shadow: 0 1px 0 rgba(26, 26, 26, 0.06);
  }

  .header-scrolled #header-inner {
    height: 64px;
  }
</style>

<script>
  const header = document.getElementById('site-header');
  const headerInner = document.getElementById('header-inner');
  const menuBtn = document.getElementById('mobile-menu-btn');
  const mobileMenu = document.getElementById('mobile-menu');
  
  let isMenuOpen = false;
  let lastScrollY = 0;
  let ticking = false;

  function updateHeader() {
    const scrollY = window.scrollY;
    
    if (scrollY > 50) {
      header?.classList.add('header-scrolled');
    } else {
      header?.classList.remove('header-scrolled');
    }
    
    lastScrollY = scrollY;
    ticking = false;
  }

  function onScroll() {
    if (!ticking) {
      requestAnimationFrame(updateHeader);
      ticking = true;
    }
  }

  function toggleMenu() {
    isMenuOpen = !isMenuOpen;
    
    if (isMenuOpen) {
      mobileMenu?.classList.remove('mobile-menu-closed');
      mobileMenu?.classList.add('mobile-menu-open');
      menuBtn?.classList.add('menu-open');
      menuBtn?.setAttribute('aria-expanded', 'true');
    } else {
      mobileMenu?.classList.remove('mobile-menu-open');
      mobileMenu?.classList.add('mobile-menu-closed');
      menuBtn?.classList.remove('menu-open');
      menuBtn?.setAttribute('aria-expanded', 'false');
    }
  }

  window.addEventListener('scroll', onScroll, { passive: true });
  menuBtn?.addEventListener('click', toggleMenu);
  
  updateHeader();
</script>
